const fs = require('fs');
const https = require('https');

function fetchDailySatPrice() {
    return new Promise((resolve, reject) => {
        const url = 'https://dailysatprice.com/data/latest.csv';

        https.get(url, (response) => {
            let data = '';

            response.on('data', (chunk) => {
                data += chunk;
            });

            response.on('end', () => {
                resolve(data);
            });

        }).on('error', (err) => {
            reject(err);
        });
    });
}

async function updateBtcData() {
    try {
        console.log('Fetching BTC price data from dailysatprice.com...');
        const csvData = await fetchDailySatPrice();

        // Parse CSV
        const lines = csvData.trim().split('\n');

        // Skip header and process each line
        const allData = [];
        for (let i = 1; i < lines.length; i++) {
            const [date, price] = lines[i].split(',');
            if (date && price) {
                allData.push({
                    date: date.trim(),
                    price: parseFloat(price.trim())
                });
            }
        }

        // Filter to only keep monthly data points (last day of each month with data)
        const monthlyData = new Map();
        for (const entry of allData) {
            const yearMonth = entry.date.substring(0, 7); // YYYY-MM format
            monthlyData.set(yearMonth, entry); // This will keep the last entry for each month
        }

        // Convert map to array and sort by date
        const btcData = Array.from(monthlyData.values()).sort((a, b) =>
            a.date.localeCompare(b.date)
        );

        console.log(`Fetched ${allData.length} total records, filtered to ${btcData.length} monthly data points`);
        console.log(`Date range: ${btcData[0].date} to ${btcData[btcData.length - 1].date}`);

        // Read existing data.js to preserve other data
        const dataJsContent = fs.readFileSync('data.js', 'utf8');

        // Find the mnavHistoricalData section
        const mnavMatch = dataJsContent.match(/const mnavHistoricalData = (\[[\s\S]*?\]);/);
        const strMatch = dataJsContent.match(/const strHistoricalData = (\{[\s\S]*?\});/);
        const modelMatch = dataJsContent.match(/(\/\/ Rainbow model[\s\S]*?const presetConfigs[\s\S]*?\};)/);

        // Build new data.js content
        let newContent = '// Generated by fetch-dailysatprice.js\n\n';
        newContent += `const btcHistoricalData = ${JSON.stringify(btcData, null, 2)};\n\n`;

        if (mnavMatch) {
            newContent += `const mnavHistoricalData = ${mnavMatch[1]};\n\n`;
        }

        if (strMatch) {
            newContent += `const strHistoricalData = ${strMatch[1]};\n\n`;
        }

        if (modelMatch) {
            newContent += modelMatch[1] + '\n';
        }

        // Write updated data
        fs.writeFileSync('data.js', newContent);
        console.log('Successfully updated data.js with new BTC price data');

    } catch (error) {
        console.error('Error updating BTC data:', error);
        process.exit(1);
    }
}

updateBtcData();